# Bobry
LABA 1 postgreSQL

ВЫПОЛНЕНИЕ ЗАДАНИЯ

В ходе выполнения работы были написаны программные коды для автонастройки Мастера и Реплики (Master & Slave) 

Они были подняты согласно схеме scheme.png

В данной реализации не предусмотрена автонастройка Арбитра (Arbitor). Он настраивается вручную, напрмер на виртуальной машине Linux
 
ИСПОЛЬЗОВАННЫЕ ИСТОЧНИКИ

https://docs.google.com/document/d/1mbRoLjxO-9ZaCfNAMT6rGjHRYDFjA75hP7UPx6B7Vmc/edit#        - методическое пособие 

https://eax.me/postgresql-replication/

https://habr.com/ru/post/188096/

https://newtechaudit.ru/potokovaya-replikacziya-postgresql/

https://losst.ru/replikatsiya-postgresql

https://adminguide.ru/2019/04/07/postgresql-10-потоковая-репликация-с-отработкой/


ЗАДАНИЕ ( https://docs.google.com/document/d/1mbRoLjxO-9ZaCfNAMT6rGjHRYDFjA75hP7UPx6B7Vmc/edit# )

Практическое изучение отказоустойчивости, часть 1. Обработка отказа СУБД при помощи физической потоковой репликации.
Необходимо написать программу-агента, которая создаёт отказоустойчивый кластер PostgreSQL.
Топология кластера при этом получается примерно такой:

Здесь M - мастре репликации, в документации primary node. S - синхронная реплика, в документации standby with streaming replication and synchronous_commit=on.
M и S находятся на различных сетевых хостах (виртуальных машинах, docker контейнерах или реальных физических серверах). Кроме хостов СУБД есть ещё хост-арбитр.
Процесс настройки потоковой репликации подробно и немного избыточно описан в https://momjian.us/main/writings/pgsql/hot_streaming_rep.pdf

Программа-агент запущена на каждом из хостов. Свои настройки получает из файлов конфигурации и безопасно для работоспособности системы переживает перезапуск.
Самое главное - программа-агент в случае потери сетевой связности мастера делает promote локальной СУБД до мастера. Для того чтобы проверить, что сетевая связность потеряна у M, а не у S, используется координирование с арбитром. Promote не происходит, если у S нет связи ни с M, ни с А. Promote происходит если у S нет связи с M и А подтверждает отсутствие связи с М.
В случае потери связи с А, но признаков жизни на М promote также не происходит.

Топология с А:

В документации Арбитра иногда называют Свидетелем (witness).
Топология promote

Важно помнить, что М при отсутствии реплики и связи с арбитром тоже должен быть закрыт (например через iptables).

Инструментарий
Утилиты PostgreSQL
initdb - создаёт пустую базу данных
pg_ctl - запускает и останавливает базу данных, инициирует promote базе
pg_basebackup - создаёт копию базы данных
pgisready - проверяет доступность базы данных
Для настройки реплики нужно создать файл recovery.conf и запустить базу, она начнёт процесс воспроизведения у себя транзакций с М.
Документация тут https://postgrespro.ru/docs/postgrespro/11/app-pg-ctl
Офф доеументация на английском https://www.postgresql.org/docs/10/app-pg-ctl.html

Признаки жизнедеятельности базы:
Можно подключиться к базе по порту 5432 и выполнить запрос “select 1;”

Артефакты
1. Программа-агент на github, gitlab, bb или pastebin
2. Собранный с её помощью стенд в котором можно оторвать сеть у M и проверить что в бывший S теперь можно выполнить пишущий запрос (например “create table x(i int);”)

Минимальное тестирование функциональности
С помощью утилиты нагрузочного тестирования pgbench можно запустить пишущую нагрузку на кластер. В момент failover нагрузка временно отпадает а потом пере>дёт на новый мастер.
Для того чтобы pgbench видел оба хоста их надо перечислить через запятую host=127.0.0.1,192.168.0.2 и указать target_session_attrs=read-write .








